@model BenevoleWithAdresseAndVehicule

@{
    ViewData["Title"] = "Créer";
}

<h2>Gestion des bénévoles</h2>

<h3>Créer un bénévole</h3>
<hr />
<div class="row">
    <form asp-action="Create" asp-antiforgery="true" onsubmit="submit();">
        <div asp-validation-summary="All" class="text-danger"></div>
        <div class="col-md-4">
            <div class="panel panel-default">
                <div class="panel-heading">Identification</div>
                <div class="panel-body">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label asp-for="Benevole.Nom" class="control-label required"></label>
                            <input asp-for="Benevole.Nom" class="form-control" />
                            <span asp-validation-for="Benevole.Nom" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="Benevole.Prenom" class="control-label required"></label>
                            <input asp-for="Benevole.Prenom" class="form-control" />
                            <span asp-validation-for="Benevole.Prenom" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="Benevole.Telephone" class="control-label required"></label>
                            <input asp-for="Benevole.Telephone" class="form-control" />
                            <span asp-validation-for="Benevole.Telephone" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="panel panel-default">
                <div class="panel-heading">Adresse &amp; Centre</div>
                <div class="panel-body">
                    <div class="col-md-8">
                        <fieldset>
                            <div class="form-group">
                                <label asp-for="Adresse.AdresseLigne1" class="control-label required"></label>
                                <input asp-for="Adresse.AdresseLigne1" class="form-control" />
                                <span asp-validation-for="Adresse.AdresseLigne1" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Adresse.AdresseLigne2" class="control-label"></label>
                                <input asp-for="Adresse.AdresseLigne2" class="form-control" />
                                <span asp-validation-for="Adresse.AdresseLigne2" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Adresse.AdresseLigne3" class="control-label"></label>
                                <input asp-for="Adresse.AdresseLigne3" class="form-control" />
                                <span asp-validation-for="Adresse.AdresseLigne3" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Adresse.CodePostal" class="control-label required"></label>
                                <input asp-for="Adresse.CodePostal" class="form-control" />
                                <span asp-validation-for="Adresse.CodePostal" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Adresse.Ville" class="control-label required"></label>
                                <input asp-for="Adresse.Ville" class="form-control" />
                                <span asp-validation-for="Adresse.Ville" class="text-danger"></span>
                            </div>
                            <hr/>
                            <div class="form-group">
                                <label asp-for="Adresse.CentreID" class="control-label required"></label>
                                <select asp-for="Adresse.CentreID" asp-items="@(new SelectList(ViewBag.Centres, "ID","Nom"))" class="form-control">
                                    <option value="">- Veuillez sélectionner un centre -</option>
                                </select>
                                <span asp-validation-for="Adresse.CentreID" class="text-danger"></span>
                            </div>
                            <div class="form-group">
                                <label asp-for="Adresse.DistanceCentre" class="control-label required"></label>
                                <input id="DistanceCentre" asp-for="Adresse.DistanceCentre" class="form-control" onblur="validateDistance();" />
                                <span id="validationDistance" class="text-danger" style="display:none"></span>
                            </div>
                        </fieldset>
                        <div class="alert alert-warning">
                            <p>
                                <span>Si le bénévole ne prend pas son véhicule ou n'a pas le droit de déclarer ses frais en dons, veuillez renseigner la valeur 0,00.</span>
                            </p>
                        </div>
                        <div class="alert alert-info">
                            <p>
                                <span>Merci d’utiliser <a href="http://www.mappy.fr" target="_blank"><strong>MAPPY</strong></a> afin de déterminer la distance la plus courte A/R du domicile au lieu de bénévolat.</span>
                            </p>
                            @* ITINERAIRE PRE REMPLI
                            <p>
                                <a href="#" target="_blank" onclick="setMappyUrl(this);"><strong>Cliquez ici</strong></a> pour ouvrir Mappy avec l'itinéraire pré-rempli
                            </p>*@
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="panel panel-default">
                <div class="panel-heading">Identification Véhicule</div>
                <div class="panel-body">
                    <div class="col-md-8">
                        <div class="form-group">
                            <label asp-for="Vehicule.DateChangement" class="control-label required"></label>
                            <input asp-for="Vehicule.DateChangement" id="dateChangement" class="form-control" />
                            <span asp-validation-for="Vehicule.DateChangement" class="text-danger"></span>
                        </div>
                        <hr />
                        <fieldset>
                            <div class="form-group">
                                <label asp-for="Vehicule.NbChevaux" class="control-label required"></label>
                                <input asp-for="Vehicule.NbChevaux" id="nbChevaux" class="form-control" />
                                <span asp-validation-for="Vehicule.NbChevaux" class="text-danger"></span>
                            </div>
                            <hr />
                        </fieldset>
                        <div class="form-group" style="float:left">
                            <label asp-for="Vehicule.IsElectric" class="control-label required"></label>
                            <input asp-for="Vehicule.IsElectric" type="checkbox" class="form-control" style="max-height:20px;" />
                            <span asp-validation-for="Vehicule.IsElectric" class="text-danger"></span>
                        </div>
                        <div class="form-group" style="float:left">
                            <span id="validationVehicule" class="text-danger" style="display:none"></span>
                        </div>
                    </div>
                </div>
            </div>     
        </div>
       
    </form>
    <div class="form-group" style="float:right">
        <button type="button" class="btn btn-success" onclick="submit(); return false;">Créer</button>
        <a asp-action="Index" class="btn btn-link">Retourner à la liste</a>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

<script type="text/javascript">

    function validateDistance() {

        var valDistance = $("#DistanceCentre").val();
        var distance = parseFloat(valDistance.replace(",", ".").replace(".", "!"));       

        if (isNaN(distance)) {
            $("#validationDistance").html("Veuillez renseigner un nombre valide");
            $("#validationDistance").show();
            return false;
        } else if (distance < 0) {
            $("#validationDistance").html("La distance doit être supérieure ou égale à zéro");
            $("#validationDistance").show();
            return false;
        } else {
            $("#validationDistance").hide();
            return true;
        }
    }

    function validateVehicule() {
        var retval = true;
        var dateChange = $("#dateChangement").val();
        if ($("#nbChevaux").val() == 0) {

            $("#validationVehicule").html("Veuillez renseigner un nombre valide de chevaux fiscaux");
            $("#validationVehicule").show();
            retval = false;

        } else if (!isValidDate(dateChange) ) {

            $("#validationVehicule").html("Veuillez rentrer une date valide d'acquisition de votre véhicule.");
            $("#validationVehicule").show();
            retval = false;
        }

        return retval;

    }

    function isValidDate(dateString) {
        // Check if the date format is yyyy-mm-ddTHH:MM
        var regex = /^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})$/;
        if (!regex.test(dateString)) {
            return false;
        }

        // Parse the date parts to integers
        var parts = dateString.split(/[-T:]/);
        var year = parseInt(parts[0], 10);
        var month = parseInt(parts[1], 10) - 1; // Months are 0-based in JavaScript
        var day = parseInt(parts[2], 10);
        var hours = parseInt(parts[3], 10);
        var minutes = parseInt(parts[4], 10);

        // Check if the date is valid
        var date = new Date(year, month, day, hours, minutes);
        var dateCheck = date.getFullYear();
        var monthCheck = date.getMonth();
        var dayCheck = date.getDate();

        // Additional check to ensure the year is not too far in the past
        if (year < 1901) {
            return false;
        }

        if (dateCheck !== year || monthCheck !== month || dayCheck !== day) {
            return false;
        }

       

        return true;
    }

    function submit() {

        if (!validateDistance() || !validateVehicule()) {
                return;
        }
            

        $("form").submit();
    }

</script>
}
